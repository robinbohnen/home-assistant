covers_package:
  group:
    covers_first_floor:
      name: Rolluiken eerste verdieping
      icon: mdi:window-shutter
      entities:
        - cover.kantoor_links_low_speed
        - cover.kantoor_rechts_low_speed
        - cover.badkamer_rolluik_low_speed
        - cover.slaapkamer_rolluik_low_speed
        - cover.slaapkamer_maxi_links_low_speed
        - cover.slaapkamer_maxi_rechts_low_speed
        - cover.slaapkamer_mini

    covers_kitchen_rollerblinds:
      name: Rolgordijnen keuken
      icon: mdi:blinds
      entities:
        - cover.rollerblind_0001
        - cover.rollerblind_0002

    covers_children_bedrooms:
      name: Rolluiken kinderkamers
      icon: mdi:window-shutter
      entities:
        - cover.slaapkamer_maxi_links_low_speed
        - cover.slaapkamer_maxi_rechts_low_speed
        - cover.slaapkamer_mini

  automation:
    #################################################################
    ## Bedroom button press - open covers
    #################################################################
    - id: covers_bedroom_button
      alias: Covers - Bedroom button press
      description: Open covers when bedroom button is pressed
      mode: single
      triggers:
        - domain: mqtt
          device_id: !secret bedroom_button_1
          type: action
          subtype: single
          trigger: device
          id: bedroom_buttons_pressed
        - domain: mqtt
          device_id: !secret bedroom_button_2
          type: action
          subtype: single
          trigger: device
          id: bedroom_buttons_pressed
      conditions: []
      actions:
        - choose:
            - conditions:
                - condition: time
                  after: "06:00:00"
                  before: "17:00:00"
              sequence:
                - if:
                    - condition: numeric_state
                      entity_id: sensor.voortuin_zon_luminance
                      above: 20000
                  then:
                    - action: cover.open_cover
                      data: {}
                      target:
                        entity_id:
                          - cover.badkamer_rolluik_low_speed
                          - cover.slaapkamer_rolluik_low_speed
                    - action: cover.close_cover
                      data: {}
                      target:
                        entity_id:
                          - cover.keuken_screen_links
                          - cover.keuken_screen_rechts
                  else:
                    - action: cover.open_cover
                      data: {}
                      target:
                        entity_id: group.covers_first_floor
                    - action: cover.open_cover
                      data: {}
                      target:
                        entity_id: group.covers_kitchen_rollerblinds

    #################################################################
    ## Lock/alarm events - open/close kitchen rollerblinds
    #################################################################
    - id: covers_lock_alarm_events
      alias: Covers - Lock and alarm events
      description: Open or close covers based on lock and alarm state changes
      mode: single
      triggers:
        - trigger: state
          entity_id:
            - lock.kroon18voordeur
          to: unlocked
          id: lock_unlocked
        - trigger: state
          entity_id:
            - alarm_control_panel.alarmo
          to: disarmed
          id: alarm_off
        - trigger: state
          entity_id:
            - alarm_control_panel.alarmo
          to: armed_away
          id: alarm_on_not_home
        - trigger: state
          entity_id:
            - alarm_control_panel.alarmo
          to: armed_home
          id: alarm_on_home
        - trigger: state
          entity_id:
            - lock.kroon18voordeur
          to: locked
          id: lock_locked
      conditions: []
      actions:
        - choose:
            - conditions:
                - condition: trigger
                  id:
                    - lock_unlocked
                    - alarm_off
              sequence:
                - if:
                    - condition: time
                      after: "08:30:00"
                      before: "19:00:00"
                    - condition: numeric_state
                      entity_id: sensor.voortuin_zon_luminance
                      below: 20000
                    - condition: sun
                      before: sunset
                      before_offset: "-00:30:00"
                  then:
                    - action: cover.open_cover
                      data: {}
                      target:
                        entity_id: group.covers_kitchen_rollerblinds
            - conditions:
                - condition: trigger
                  id:
                    - alarm_on_not_home
                    - alarm_on_home
                    - lock_locked
              sequence:
                - alias: Close covers when windows are closed and no-one is home
                  if:
                    - condition: or
                      conditions:
                        - condition: not
                          conditions:
                            - condition: state
                              entity_id: group.all_adults
                              state: home
                        - condition: time
                          after: "18:45:00"
                          before: "01:00:00"
                  then:
                    - if:
                        - condition: state
                          entity_id: binary_sensor.keuken_raam_groot_contact
                          state: "off"
                      then:
                        - action: cover.close_cover
                          data: {}
                          target:
                            entity_id: cover.rollerblind_0001
                    - if:
                        - condition: state
                          entity_id: binary_sensor.keuken_raam_klein_contact
                          state: "off"
                      then:
                        - action: cover.close_cover
                          data: {}
                          target:
                            entity_id: cover.rollerblind_0002

    #################################################################
    ## Sun protection - kitchen screens based on frontyard luminance
    #################################################################
    - id: covers_sun_protection
      alias: Covers - Sun protection screens
      description: Close or open kitchen sunscreens based on frontyard sun luminance
      mode: single
      triggers:
        - trigger: numeric_state
          entity_id:
            - sensor.voortuin_zon_luminance
          above: 20000
          for:
            minutes: 15
          id: luminance_frontyard_above_20000
        - trigger: numeric_state
          entity_id:
            - sensor.voortuin_zon_luminance
          below: 20000
          for:
            minutes: 15
          id: luminance_frontyard_below_20000
      conditions: []
      actions:
        - choose:
            - conditions:
                - condition: trigger
                  id:
                    - luminance_frontyard_above_20000
              sequence:
                - action: cover.close_cover
                  data: {}
                  target:
                    entity_id: cover.covers_kitchen_screens
              alias: Sunscreens down
            - conditions:
                - condition: trigger
                  id:
                    - luminance_frontyard_below_20000
              sequence:
                - action: cover.open_cover
                  data: {}
                  target:
                    entity_id: cover.covers_kitchen_screens
                - if:
                    - condition: state
                      entity_id: group.all_adults
                      state: home
                    - condition: time
                      after: "07:00:00"
                      before: "18:45:00"
                  then:
                    - action: cover.open_cover
                      data: {}
                      target:
                        entity_id: group.covers_kitchen_rollerblinds
              alias: Sunscreens up

    #################################################################
    ## Morning routine - open covers based on weather conditions
    #################################################################
    - id: covers_morning_routine
      alias: Covers - Morning routine
      description: Open or close covers in the morning based on temperature and sun
      mode: single
      triggers:
        - trigger: time
          at: "09:30:00"
          id: morning
        - trigger: numeric_state
          entity_id:
            - sensor.knmi_temperatuur
          above: 20
          id: temperature_above_20
        - trigger: numeric_state
          entity_id:
            - sensor.achtertuin_zon_luminance
          above: 20000
          for:
            minutes: 15
          id: luminance_backyard_above_20000
        - trigger: numeric_state
          entity_id:
            - sensor.achtertuin_zon_luminance
          below: 20000
          for:
            minutes: 15
          id: luminance_backyard_below_20000
      conditions:
        - alias: Only during daytime
          condition: time
          after: "08:00:00"
          before: "17:00:00"
      actions:
        - alias: Check weather conditions
          choose:
            - conditions:
                - condition: numeric_state
                  entity_id: weather.knmi_thuis
                  attribute: temperature
                  above: 20
                  alias: Hot
              sequence:
                - action: cover.close_cover
                  data: {}
                  target:
                    entity_id: group.covers_first_floor
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.voortuin_zon_luminance
                  above: 20000
                  alias: Sunny frontyard
              sequence:
                - action: cover.close_cover
                  data: {}
                  target:
                    entity_id:
                      - cover.keuken_screen_links
                      - cover.keuken_screen_rechts
                - if:
                    - condition: state
                      entity_id: binary_sensor.keuken_raam_klein_contact
                      state: "off"
                  then:
                    - action: cover.close_cover
                      data: {}
                      target:
                        entity_id: cover.rollerblind_0002
                  alias: Rolgordijn rechts dicht
                - if:
                    - condition: state
                      entity_id: binary_sensor.keuken_raam_groot_contact
                      state: "off"
                  then:
                    - action: cover.close_cover
                      data: {}
                      target:
                        entity_id: cover.rollerblind_0001
                  alias: Rolgordijn links dicht
                - if:
                    - condition: state
                      entity_id: light.woonkamer_lampen
                      state: "on"
                  then:
                    - action: cover.set_cover_position
                      data:
                        position: 15
                      target:
                        entity_id:
                          - cover.slaapkamer_maxi_rechts_low_speed
                          - cover.slaapkamer_maxi_links_low_speed
                          - cover.kantoor_links_low_speed
                          - cover.kantoor_rechts_low_speed
                          - cover.slaapkamer_mini
                    - action: cover.open_cover
                      data: {}
                      target:
                        entity_id:
                          - cover.badkamer_rolluik_low_speed
                          - cover.slaapkamer_rolluik_low_speed
                  alias: If we are awake, open covers otherwise leave them closed
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.achtertuin_zon_luminance
                  above: 20000
                  alias: Sunny Backyard
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: 15
                  target:
                    entity_id:
                      - cover.badkamer_rolluik_low_speed
                      - cover.slaapkamer_rolluik_low_speed
                      - cover.slaapkamer_mini
                      - cover.kantoor_rechts_low_speed
                - action: cover.open_cover
                  data: {}
                  target:
                    entity_id:
                      - cover.slaapkamer_maxi_rechts_low_speed
                      - cover.slaapkamer_maxi_links_low_speed
                      - cover.kantoor_links_low_speed
          default:
            - action: cover.open_cover
              data: {}
              target:
                entity_id:
                  - cover.keuken_screen_links
                  - cover.keuken_screen_rechts
            - action: cover.open_cover
              data: {}
              target:
                entity_id: group.covers_first_floor
            - if:
                - condition: state
                  entity_id: group.all_adults
                  state: home
              then:
                - action: cover.open_cover
                  data: {}
                  target:
                    entity_id: group.covers_kitchen_rollerblinds

    #################################################################
    ## Bedtime - close covers at night
    #################################################################
    - id: covers_bedtime
      alias: Covers - Bedtime routine
      description: Close covers at night
      mode: single
      triggers:
        - trigger: time
          at: "23:00:00"
          id: midnight
      conditions: []
      actions:
        - action: cover.close_cover
          data: {}
          target:
            entity_id: group.covers_children_bedrooms
        - if:
            - condition: numeric_state
              entity_id: weather.forecast_thuis
              attribute: temperature
              below: 20
          then:
            - action: cover.set_cover_position
              data:
                position: 15
              target:
                entity_id:
                  - cover.kantoor_links_low_speed
                  - cover.kantoor_rechts_low_speed
                  - cover.badkamer_rolluik_low_speed
                  - cover.slaapkamer_rolluik_low_speed
          else:
            - action: cover.close_cover
              data: {}
              target:
                entity_id:
                  - cover.kantoor_links_low_speed
                  - cover.kantoor_rechts_low_speed
                  - cover.badkamer_rolluik_low_speed
                  - cover.slaapkamer_rolluik_low_speed
